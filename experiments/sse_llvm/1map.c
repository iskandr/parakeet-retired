#include <stdio.h>
#include <stdlib.h>
#include <sys/time.h>
#include <xmmintrin.h>

typedef struct {
  int *data;
  int *shape;
  int *strides;
} array_t;

typedef int v4si __attribute__ ((vector_size (16)));

typedef union {
  v4si v;
  int i[4];
} i4vector;

extern void map_wrapper_5B_array1_3C_int64_3E__5D_(array_t*, array_t*);
extern void map_wrapper_nosse_5B_array1_3C_int64_3E__5D_(array_t*, array_t*);
extern void map_wrapper_gen_sse(array_t*, array_t*);

void print_array(array_t *a, int num_els) {
  printf("\n[");
  int i;
  for (i = 0; i < num_els; ++i) {
    printf("%d ", a->data[i]);
  }
  printf("]\n");
}

void free_array(array_t *a) {
  free(a->data);
  free(a->shape);
  free(a->strides);
}

int main(int argc, char** argv) {
  int num_els = 16;

  if (argc == 2) {
    num_els = atoi(argv[1]);
  }
  
  // Alloc input data
  int *x = (int*)malloc(num_els * sizeof(int));
  int i;
  for (i = 0; i < num_els; ++i) {
    x[i] = i + 1;
  }
  array_t input;
  input.data = x;
  input.shape = (int*)malloc(sizeof(int));
  input.shape[0] = num_els;
  input.strides = (int*)malloc(sizeof(int));
  input.strides[0] = 4;

  // Alloc output data
  array_t output;
  output.data = (int*)malloc(num_els * sizeof(int));;
  output.shape = (int*)malloc(sizeof(int));
  output.shape[0] = num_els;
  output.strides = (int*)malloc(sizeof(int));
  output.strides[0] = 4;
  array_t nosse_output;
  nosse_output.data = (int*)malloc(num_els * sizeof(int));;
  nosse_output.shape = (int*)malloc(sizeof(int));
  nosse_output.shape[0] = num_els;
  nosse_output.strides = (int*)malloc(sizeof(int));
  nosse_output.strides[0] = 4;

  // Call assembly code generated by LLVM
  struct timeval start, stop, result;
  double sse_time, nosse_time, c_time, c_sse_time;
  gettimeofday(&start, NULL);
  map_wrapper_5B_array1_3C_int64_3E__5D_(&input, &output);
  gettimeofday(&stop, NULL);
  timersub(&stop, &start, &result);
  sse_time = result.tv_sec + result.tv_usec / 1000000.0;
  gettimeofday(&start, NULL);
  map_wrapper_nosse_5B_array1_3C_int64_3E__5D_(&input, &nosse_output);
  gettimeofday(&stop, NULL);
  timersub(&stop, &start, &result);
  nosse_time = result.tv_sec + result.tv_usec / 1000000.0;
  map_wrapper_gen_sse(&input, &output);

  // Time the C cases
  int *c_output = (int*)malloc(num_els * sizeof(int));
  i4vector v3;
  v3.i[0] = v3.i[1] = v3.i[2] = v3.i[3] = 3;
  gettimeofday(&start, NULL);
  for (i = 0; i < num_els / 4; i += 4) {
    i4vector* vo = (i4vector*)&c_output[i];
    i4vector* vi = (i4vector*)&input.data[i];
    (*vo).v = __builtin_ia32_pmulld128((*vi).v, v3.v);
  }
  gettimeofday(&stop, NULL);
  timersub(&stop, &start, &result);
  c_sse_time = result.tv_sec + result.tv_usec / 1000000.0;
  gettimeofday(&start, NULL);
  for (i = 0; i < num_els; ++i) {
    c_output[i] = x[i] * 3;
  }
  gettimeofday(&stop, NULL);
  timersub(&stop, &start, &result);
  c_time = result.tv_sec + result.tv_usec / 1000000.0;
  
  // Check that the results are good
  int sse_ok = 1;
  int nosse_ok = 1;
  for (i = 0; i < num_els; ++i) {
    sse_ok = sse_ok && (output.data[i] == c_output[i]);
    nosse_ok = nosse_ok && (nosse_output.data[i] == c_output[i]);
  }
  if (sse_ok) {
    printf("SSE output good.\n");
  } else {
    printf("SSE output not good.\n");
  }
  if (nosse_ok) {
    printf("No-SSE output good.\n");
  } else {
    printf("No-SSE output not good.\n");
  }
  printf("C SSE time: %f\n", c_sse_time);
  printf("C time: %f\n", c_time);
  printf("No-SSE time: %f\n", nosse_time);
  printf("SSE time: %f\n", sse_time);
  
  free_array(&input);
  free_array(&output);
  free_array(&nosse_output);
  free(c_output);

  return 0;
}
