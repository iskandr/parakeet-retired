open Base
open Ptx
open PtxType 
open PtxVal 
open PtxHelpers

exception InvalidGpuOp of gpu_op

let rec simplify codegen instr  =
  match instr.op with
  | VirtualUnop (Exp,t) ->
    begin
      let tmp1 = codegen#fresh_reg t in
      let tmp2 = codegen#fresh_reg t in 
      [(mov t tmp1 (FloatConst 1.44269504));
       (mul t tmp2 instr.args.(1) tmp1);
       {instr with op   = Unop (Ex2 Approx,t);
                   args = [|instr.args.(0); tmp2|]}]
    end
  | VirtualUnop (Ln,t) ->
    begin
      Printf.printf "Rewriting Virtual Ln\n";
      let tmp1 = codegen#fresh_reg t in
      let tmp2 = codegen#fresh_reg t in 
      [(mov t tmp1 (FloatConst 0.693147181));
       {instr with op = Unop (Lg2 Approx,t);
                   args = [|tmp2;instr.args.(1)|]};
       (mul t instr.args.(0) tmp2 tmp1)]
    end
  | _ -> [instr]
