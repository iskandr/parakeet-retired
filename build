printf "\n"; 
printf "===================================================\n";
printf "|                Medium Sized Whale               |\n"; 
printf "===================================================\n";

# Build parameters

if [ "$PQ_PATH" = "" ]
then 
  export PQ_PATH="../libpq"
fi 

LINKER_FLAGS="-lflags -ccopt,$PQ_PATH/libpq_stubs.o,\
-ccopt,$PQ_PATH/cuda_stubs.cu_o,\
-ccopt,$PQ_PATH/base.o,\
-ccopt,-L/usr/local/cuda/lib64/,\
-ccopt,-L/usr/lib/nvidia-current,\
-ccopt,-lcuda,\
-ccopt,-lcudart,\
-ccopt,$PQ_PATH/../OCAMLInterface/ocaml_interface.a"

SUFFIX=
TARGET="Callbacks.cmx preprocess.native"
PPFLAGS=
MAKEFLAGS=
FINALTARGET=

if [ "prof" == "$1" ]; then
  SUFFIX=".p"
  MAKEFLAGS="PROF=1"
  FINALTARGET="Time.p.native"
fi
if [ "debug" == "$1" ]; then
  PPFLAGS="-ppflag -DDEBUG"
  MAKEFLAGS="DEBUG=-g"
  export dbg=1
fi

OCAMLPP="-pp camlp4o -ppflag pa_macro.cmo"
OCAMLBUILD="ocamlbuild $LINKER_FLAGS $OCAMLPP $PPFLAGS -ocamlyacc menhir"
echo $OCAMLBUILD

cd CQInterface
# printf "\n\n ******** Cleaning CQInterface *******\n"; 
make clean
cd ..

cd OCAMLInterface
# printf "\n\n ******** Cleaning OCAMLInteface *******\n"; 
make clean
cd ..

printf "\n\n ******** Building LibPQ ********* \n";
cd libpq
#make clean 
if ! make; then echo "LibPQ build failed"; exit 1; fi 
cd ..

printf "\n\n ****** Building OCaml<->C Interface ****** \n"
cd OCAMLInterface;
if ! make $MAKEFLAGS; then echo "OCamlInterface build failed"; exit 1; fi 
cd ..

if [  "tests!" == "$1" ]; then 
  printf "\n---Building tests---\n";
  $OCAMLBUILD Tests/tests.native -yaccflag infer; 

  printf "\n---Running tests---\n";
 _build/Tests/tests.native;
else
  if [ -n "$TARGET" ]; then
    printf "\n\n******* Building Preprocessor and Q Callbacks *******\n"; 
    if ! $OCAMLBUILD $TARGET -no-hygiene; then echo "Preprocessor build failed"; exit 1; fi 
  fi


 printf "\n\n********* Building CQInterface **********\n"; 
  cd CQInterface;
  if ! make $MAKEFLAGS; then echo "CQInterface build failed"; exit 1; fi 
  mv *.o ../_build;
  mv cinterface.so ../_build;
  cd ..
 
  if [ -n "$FINALTARGET" ]; then
    printf "\n\n******** Building FINALTARGET ********\n"; 
    if ! $OCAMLBUILD $FINALTARGET; then echo "Profiling build failed"; exit 1; fi 
  fi
fi

