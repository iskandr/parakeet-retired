BUILDPATH = ../_build
CFLAGS = -Wall -m32 -O3
LDFLAGS = -lpthread -lm -lrt
CC = gcc
DEBUG =
OCAMLCC = ocamlopt
OCAMLCFLAGS = -ccopt -fPIC

OCAMLINCLUDES = -I $(BUILDPATH) -I $(BUILDPATH)/Analysis \
	-I $(BUILDPATH)/CQInterface -I $(BUILDPATH)/Dynamic -I $(BUILDPATH)/Base \
	-I $(BUILDPATH)/Ptx -I $(BUILDPATH)/GPU -I $(BUILDPATH)/Q -I $(BUILDPATH)/ResourceManager \
	-I $(BUILDPATH)/Dump \
	-I $(BUILDPATH)/extlib -I $(BUILDPATH)/AST   \
	-I $(BUILDPATH)/TypedCore  \
	-I $(BUILDPATH)/DataflowGraph -I $(BUILDPATH)/Imp \
	-I $(BUILDPATH)/UntypedSSA
   
#COBJS = -ccopt $(PQ_PATH)/libpq.so 
OBJS = cinterface.o
COBJS = -ccopt -L/usr/lib/nvidia-current -ccopt $(PQ_PATH)/cuda_stubs.o $(PQ_PATH)/libpq_stubs.o $(PQ_PATH)/../OCAMLInterface/ocaml_interface.a -ccopt -lcuda

#OCAMLOBJS := $(shell find ../_build/ -name '*.cmx' | xargs -n1 basename ) 

OCAMLOBJSRAW := unix.cmxa enum.cmx dynArray.cmx extString.cmx extHashtbl.cmx \
extList.cmx PMap.cmx std.cmx bitSet.cmx extArray.cmx \
BaseCommon.cmx Tuple.cmx BaseArray.cmx BaseList.cmx  BaseSet.cmx  BaseMap.cmx \
Graph.cmx \
Bool.cmx Float.cmx Int.cmx Float32.cmx PSet.cmx BasePMap.cmx Base.cmx \
Dict.cmx \
UID.cmx ID.cmx FnId.cmx PQNum.cmx Prim.cmx DynType.cmx \
QPrims.cmx \
SourceInfo.cmx QSyntax.cmx AST_Info.cmx AST.cmx QSyntax_to_AST.cmx \
QParser.cmx \
QLexer.cmx  \
SSA_Gates.cmx UntypedSSA.cmx AST_to_SSA.cmx \
ConstantLattice.cmx \
UntypedAnalysis.cmx \
UntypedFindConstants.cmx UntypedFindDefs.cmx \
UntypedFindGenSet.cmx UntypedFindUseCounts.cmx \
UntypedReplace.cmx UntypedInline.cmx \
UntypedFindUseSets.cmx UntypedElimDeadCode.cmx \
UntypedSimplify.cmx UntypedElimPartialApps.cmx \
UntypedSimpleCSE.cmx \
RunOptimizations.cmx \
TypedCore.cmx TypeInfer.cmx Specialize.cmx \
TypedFindConstants.cmx  \
TypedFindLiveIds.cmx \
TypedFunctionCloning.cmx \
TypedElimDeadCode.cmx \
HostPtr.cmx bigarray.cmxa PtxType.cmx PtxVal.cmx Ptx.cmx Shape.cmx GpuVal.cmx \
PtxHelpers.cmx MemoryState.cmx LibPQ.cmx \
PtxSimplify.cmx PtxTidy.cmx PtxCodegen.cmx  \
QType.cmx HardwareInfo.cmx Init.cmx \
Imp.cmx ImpCommon.cmx ImpCodegen.cmx ImpGenAllPairs.cmx \
TypedCoreToImp.cmx \
ImpGenMap.cmx ImpGenReduce.cmx ImpAbstractInterp.cmx ImpInferMemspace.cmx ImpToPtx.cmx \
DataflowGraph.cmx MapFusion.cmx OptimizeDfg.cmx \
TypedCoreToDfg.cmx SequentializeDfg.cmx EvalDfg.cmx \
Program.cmx CodeTemplate.cmx Callbacks.cmx

#$(shell ls $(BUILDPATH) -R | grep cmx | tr '\n' ' ')

ifneq ($(PROF),)
	OCAMLOBJS = $(patsubst %.cmx,%.p.cmx,$(OCAMLOBJSRAW))
	#OCAMLOBJS = $(patsubst %.cmxa,%.p.cmxa,$(OCAMLOBJSAUX1))
else
	OCAMLOBJS = $(OCAMLOBJSRAW) 
endif

all: cinterface 

cinterface: $(OBJS)
	$(OCAMLCC) -ccopt -shared -ccopt -Wl,-Bsymbolic $(OBJS) \
	$(OCAMLINCLUDES) $(COBJS) $(DEBUG) -ccopt -Wl,--start-group $(OCAMLOBJS) \
	-ccopt -Wl,--end-group -o cinterface.so -verbose

cinterface.o: cinterface.c cinterface.h
	$(OCAMLCC) $(OCAMLCFLAGS) $(DEBUG) -o cinterface.o cinterface.c

ocaml_interface.o: ocaml_interface.c ocaml_interface.h
	$(OCAMLCC) $(OCAMLCFLAGS) $(DEBUG) -o ocaml_interface.o ocaml_interface.c

clean:
	rm -f cinterface.so *~ *.o QType.cmx QType.mli QType.cmi
